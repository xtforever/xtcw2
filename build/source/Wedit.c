/* Generated by wbuild
 * (generator version 3.3)
 */
#include <X11/IntrinsicP.h>
#include <X11/StringDefs.h>
#line 635 "Wedit.widget"
#include <assert.h>
#line 636 "Wedit.widget"
#include <X11/Intrinsic.h>
#line 637 "Wedit.widget"
#include <X11/Xatom.h>
#line 638 "Wedit.widget"
#include <X11/Xmu/Converters.h>
#line 639 "Wedit.widget"
#include <X11/Xft/Xft.h>
#line 640 "Wedit.widget"
#include <X11/Xaw/XawImP.h>
#line 641 "Wedit.widget"
#include "converters.h"
#line 642 "Wedit.widget"
#include "xutil.h"
#line 643 "Wedit.widget"
#include "mls.h"
#line 644 "Wedit.widget"
#include "font.h"
#include <xtcw/WeditP.h>
#line 564 "Wedit.widget"
static void info(
#if NeedFunctionPrototypes
Widget,XEvent*,String*,Cardinal*
#endif
);
#line 569 "Wedit.widget"
static void backward_char(
#if NeedFunctionPrototypes
Widget,XEvent*,String*,Cardinal*
#endif
);
#line 575 "Wedit.widget"
static void forward_char(
#if NeedFunctionPrototypes
Widget,XEvent*,String*,Cardinal*
#endif
);
#line 581 "Wedit.widget"
static void insert_char(
#if NeedFunctionPrototypes
Widget,XEvent*,String*,Cardinal*
#endif
);
#line 595 "Wedit.widget"
static void remove_char(
#if NeedFunctionPrototypes
Widget,XEvent*,String*,Cardinal*
#endif
);
#line 601 "Wedit.widget"
static void set_cursor(
#if NeedFunctionPrototypes
Widget,XEvent*,String*,Cardinal*
#endif
);
#line 620 "Wedit.widget"
static void insert_selection(
#if NeedFunctionPrototypes
Widget,XEvent*,String*,Cardinal*
#endif
);
#line 627 "Wedit.widget"
static void notify(
#if NeedFunctionPrototypes
Widget,XEvent*,String*,Cardinal*
#endif
);

static XtActionsRec actionsList[] = {
{"info", info},
{"backward_char", backward_char},
{"forward_char", forward_char},
{"insert_char", insert_char},
{"remove_char", remove_char},
{"set_cursor", set_cursor},
{"insert_selection", insert_selection},
{"notify", notify},
};

static char defaultTranslations[] = "\
<Key>Right: forward_char() \n\
<Key>Left: backward_char() \n\
<Key>Delete: remove_char() \n\
<Key>BackSpace: backward_char() remove_char() \n\
<Ctrl>x: info() \n\
<Ctrl>v: insert_selection() \n\
<Btn1Down>: set_cursor() \n\
<Key>Return: notify() \n\
<Key>: insert_char() \n\
";
static void _resolve_inheritance(
#if NeedFunctionPrototypes
WidgetClass
#endif
);
#line 65 "Wedit.widget"
static void initialize(
#if NeedFunctionPrototypes
Widget ,Widget,ArgList ,Cardinal *
#endif
);
#line 91 "Wedit.widget"
static void destroy(
#if NeedFunctionPrototypes
Widget
#endif
);
#line 101 "Wedit.widget"
static Boolean  set_values(
#if NeedFunctionPrototypes
Widget ,Widget ,Widget,ArgList ,Cardinal *
#endif
);
#line 114 "Wedit.widget"
static void get_values_hook(
#if NeedFunctionPrototypes
Widget,ArgList ,Cardinal *
#endif
);
#line 130 "Wedit.widget"
static void expose(
#if NeedFunctionPrototypes
Widget,XEvent *,Region 
#endif
);
#line 138 "Wedit.widget"
static void realize(
#if NeedFunctionPrototypes
Widget,XtValueMask *,XSetWindowAttributes *
#endif
);
#line 145 "Wedit.widget"
static void resize(
#if NeedFunctionPrototypes
Widget
#endif
);
#line 152 "Wedit.widget"
static void resize_widget(
#if NeedFunctionPrototypes
Widget
#endif
);
#line 179 "Wedit.widget"
static void clear_pixmap(
#if NeedFunctionPrototypes
Widget
#endif
);
#line 185 "Wedit.widget"
static void draw_text_on_pixmap(
#if NeedFunctionPrototypes
Widget
#endif
);
#line 191 "Wedit.widget"
static void draw_pixmap_on_window(
#if NeedFunctionPrototypes
Widget
#endif
);
#line 198 "Wedit.widget"
static XftGlyphFontSpec * get_glyph_spec(
#if NeedFunctionPrototypes
Widget,int 
#endif
);
#line 204 "Wedit.widget"
static void draw_cursor(
#if NeedFunctionPrototypes
Widget
#endif
);
#line 218 "Wedit.widget"
static void dump(
#if NeedFunctionPrototypes
Widget
#endif
);
#line 228 "Wedit.widget"
static void paint(
#if NeedFunctionPrototypes
Widget
#endif
);
#line 239 "Wedit.widget"
static void cursor_toggle(
#if NeedFunctionPrototypes
Widget
#endif
);
#line 245 "Wedit.widget"
static void cursor_undraw(
#if NeedFunctionPrototypes
Widget
#endif
);
#line 251 "Wedit.widget"
static void cursor_xdraw(
#if NeedFunctionPrototypes
Widget,XRectangle *
#endif
);
#line 260 "Wedit.widget"
static void calculate_prefered_size(
#if NeedFunctionPrototypes
Widget,int *,int *
#endif
);
#line 268 "Wedit.widget"
static void calculate_size(
#if NeedFunctionPrototypes
Widget,int *,int *
#endif
);
#line 275 "Wedit.widget"
static void copy_str(
#if NeedFunctionPrototypes
Widget,char *
#endif
);
#line 285 "Wedit.widget"
static void reinit(
#if NeedFunctionPrototypes
Widget
#endif
);
#line 295 "Wedit.widget"
static void make_resize_request(
#if NeedFunctionPrototypes
Widget,int ,int 
#endif
);
#line 303 "Wedit.widget"
static void alloc_colors(
#if NeedFunctionPrototypes
Widget
#endif
);
#line 326 "Wedit.widget"
static void free_colors(
#if NeedFunctionPrototypes
Widget
#endif
);
#line 339 "Wedit.widget"
static void draw_glyphs_spec(
#if NeedFunctionPrototypes
Widget,int ,int 
#endif
);
#line 356 "Wedit.widget"
static void draw_glyphs(
#if NeedFunctionPrototypes
Widget
#endif
);
#line 375 "Wedit.widget"
static void unicode_to_glyphspec(
#if NeedFunctionPrototypes
Widget,uint ,XftGlyphFontSpec *,int *,int *,int *
#endif
);
#line 405 "Wedit.widget"
static void str_to_glyphlist(
#if NeedFunctionPrototypes
Widget
#endif
);
#line 431 "Wedit.widget"
static int  char_offset(
#if NeedFunctionPrototypes
Widget,int 
#endif
);
#line 442 "Wedit.widget"
static void insert_char_at_cursor(
#if NeedFunctionPrototypes
Widget,char *,int 
#endif
);
#line 451 "Wedit.widget"
static void remove_char_at_cursor(
#if NeedFunctionPrototypes
Widget
#endif
);
#line 463 "Wedit.widget"
static char  scroll_left(
#if NeedFunctionPrototypes
Widget
#endif
);
#line 473 "Wedit.widget"
static char  scroll_right(
#if NeedFunctionPrototypes
Widget
#endif
);
#line 488 "Wedit.widget"
static int  px_left_offset(
#if NeedFunctionPrototypes
Widget
#endif
);
#line 496 "Wedit.widget"
static int  px_char(
#if NeedFunctionPrototypes
Widget,int 
#endif
);
#line 506 "Wedit.widget"
static int  screen_px(
#if NeedFunctionPrototypes
Widget,int 
#endif
);
#line 518 "Wedit.widget"
static void cursor_right(
#if NeedFunctionPrototypes
Widget
#endif
);
#line 536 "Wedit.widget"
static void cursor_left(
#if NeedFunctionPrototypes
Widget
#endif
);
#line 551 "Wedit.widget"
static void RequestSelection(
#if NeedFunctionPrototypes
Widget,XtPointer ,Atom *,Atom *,XtPointer ,unsigned  long *,int *
#endif
);
#line 152 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 152 "Wedit.widget"
static void resize_widget(Widget self)
#else
#line 152 "Wedit.widget"
static void resize_widget(self)Widget self;
#endif
#line 153 "Wedit.widget"
{
        /*
        int w;
	if( $cornerRoundPercent >0 && $cornerRoundPercent < 100 ) {
	    w = Min($height,$width);
	    w = w * $cornerRoundPercent / 100;
	    XmuReshapeWidget( $, XmuShapeRoundedRectangle, w, w );
	}
        */

    if( ((WeditWidget)self)->wedit.pix.data ) { XFreePixmap( XtDisplay(self), ((WeditWidget)self)->wedit.pix.data ); }
    ((WeditWidget)self)->wedit.pix.data = XtCreatePixmap(self,((WeditWidget)self)->core.width,((WeditWidget)self)->wedit.txt.height);
    ((WeditWidget)self)->wedit.pix.r.width = ((WeditWidget)self)->core.width; ((WeditWidget)self)->wedit.pix.r.height = ((WeditWidget)self)->wedit.txt.height;

    ((WeditWidget)self)->wedit.pix.r.x = 0;  ((WeditWidget)self)->wedit.pix.r.y = (((WeditWidget)self)->core.height - ((WeditWidget)self)->wedit.txt.height) / 2;
    if( ! ((WeditWidget)self)->wedit.draw ) {
        ((WeditWidget)self)->wedit.draw = XtXftDrawCreate(self,((WeditWidget)self)->wedit.pix.data);
    }
    else {
        XftDrawChange(((WeditWidget)self)->wedit.draw,((WeditWidget)self)->wedit.pix.data);
    }

    ((WeditWidget)self)->wedit.left_char_offset = 0;
    ((WeditWidget)self)->wedit.crsr_pos = 0;
}
#line 179 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 179 "Wedit.widget"
static void clear_pixmap(Widget self)
#else
#line 179 "Wedit.widget"
static void clear_pixmap(self)Widget self;
#endif
#line 180 "Wedit.widget"
{
   XFillRectangle(XtDisplay(self),((WeditWidget)self)->wedit.pix.data,
                       ((WeditWidget)self)->wedit.gc[BG], 0,0, ((WeditWidget)self)->wedit.pix.r.width, ((WeditWidget)self)->wedit.pix.r.height );
}
#line 185 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 185 "Wedit.widget"
static void draw_text_on_pixmap(Widget self)
#else
#line 185 "Wedit.widget"
static void draw_text_on_pixmap(self)Widget self;
#endif
#line 186 "Wedit.widget"
{
    /* str_to_glyphlist($); */
    draw_glyphs(self);
}
#line 191 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 191 "Wedit.widget"
static void draw_pixmap_on_window(Widget self)
#else
#line 191 "Wedit.widget"
static void draw_pixmap_on_window(self)Widget self;
#endif
#line 192 "Wedit.widget"
{
        XtCopyArea(self, ((WeditWidget)self)->wedit.pix.data, XtWindow(self),
                   0,0, ((WeditWidget)self)->wedit.pix.r.width, ((WeditWidget)self)->wedit.pix.r.height, /* src */
                   ((WeditWidget)self)->wedit.pix.r.x, ((WeditWidget)self)->wedit.pix.r.y );             /* dest */
}
#line 198 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 198 "Wedit.widget"
static XftGlyphFontSpec * get_glyph_spec(Widget self,int  p)
#else
#line 198 "Wedit.widget"
static XftGlyphFontSpec * get_glyph_spec(self,p)Widget self;int  p;
#endif
#line 199 "Wedit.widget"
{
        return mls(((WeditWidget)self)->wedit.glyph_m, p);
}
#line 204 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 204 "Wedit.widget"
static void draw_cursor(Widget self)
#else
#line 204 "Wedit.widget"
static void draw_cursor(self)Widget self;
#endif
#line 205 "Wedit.widget"
{
        XRectangle r;
        if( ((WeditWidget)self)->wedit.crsr_pos >= m_len(((WeditWidget)self)->wedit.glyph_m) )
            ((WeditWidget)self)->wedit.crsr_pos=m_len(((WeditWidget)self)->wedit.glyph_m)-1;

        r.width = INT(((WeditWidget)self)->wedit.glyph_xoff_m,((WeditWidget)self)->wedit.crsr_pos);
        r.x = screen_px(self, ((WeditWidget)self)->wedit.crsr_pos) + ((WeditWidget)self)->wedit.pix.r.x;
        r.y = ((WeditWidget)self)->wedit.pix.r.y;
        r.height = ((WeditWidget)self)->wedit.xftFont->height;
        cursor_xdraw( self, &r );
}
#line 218 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 218 "Wedit.widget"
static void dump(Widget self)
#else
#line 218 "Wedit.widget"
static void dump(self)Widget self;
#endif
#line 219 "Wedit.widget"
{
    int i; for(i=0;i< m_len(((WeditWidget)self)->wedit.str_m)-1; i++)
               printf("%x ", (unsigned char) CHAR(((WeditWidget)self)->wedit.str_m, i) );
    putc(10,stdout);
    fwrite( m_buf(((WeditWidget)self)->wedit.str_m), m_len(((WeditWidget)self)->wedit.str_m), 1, stdout );
    printf("Left:%d Crsr:%d\n", ((WeditWidget)self)->wedit.left_char_offset, ((WeditWidget)self)->wedit.crsr_pos );
}
#line 228 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 228 "Wedit.widget"
static void paint(Widget self)
#else
#line 228 "Wedit.widget"
static void paint(self)Widget self;
#endif
#line 229 "Wedit.widget"
{
        clear_pixmap(self);
        draw_text_on_pixmap(self);
        draw_pixmap_on_window(self); ((WeditWidget)self)->wedit.crsr_on = 0;
        draw_cursor(self);
        ((WeditWidget)self)->wedit.dirty = 0;
}
#line 239 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 239 "Wedit.widget"
static void cursor_toggle(Widget self)
#else
#line 239 "Wedit.widget"
static void cursor_toggle(self)Widget self;
#endif
#line 240 "Wedit.widget"
{
        ((WeditWidget)self)->wedit.crsr_on ^= 1;
        XtFillRectangle(self, ((WeditWidget)self)->wedit.gc[CRSR], & ((WeditWidget)self)->wedit.crsr_rect );
}
#line 245 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 245 "Wedit.widget"
static void cursor_undraw(Widget self)
#else
#line 245 "Wedit.widget"
static void cursor_undraw(self)Widget self;
#endif
#line 246 "Wedit.widget"
{
    if( ((WeditWidget)self)->wedit.crsr_on ) cursor_toggle(self);
}
#line 251 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 251 "Wedit.widget"
static void cursor_xdraw(Widget self,XRectangle * r)
#else
#line 251 "Wedit.widget"
static void cursor_xdraw(self,r)Widget self;XRectangle * r;
#endif
#line 252 "Wedit.widget"
{
    cursor_undraw(self);
    ((WeditWidget)self)->wedit.crsr_rect = *r;
    cursor_toggle(self);
}
#line 260 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 260 "Wedit.widget"
static void calculate_prefered_size(Widget self,int * w,int * h)
#else
#line 260 "Wedit.widget"
static void calculate_prefered_size(self,w,h)Widget self;int * w;int * h;
#endif
#line 261 "Wedit.widget"
{
  calculate_size(self,w,h);
  (*w) += 20;
  (*h) += 20;
}
#line 268 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 268 "Wedit.widget"
static void calculate_size(Widget self,int * w,int * h)
#else
#line 268 "Wedit.widget"
static void calculate_size(self,w,h)Widget self;int * w;int * h;
#endif
#line 269 "Wedit.widget"
{
    *w = ((WeditWidget)self)->wedit.txt.width;
    *h = ((WeditWidget)self)->wedit.txt.height;
    /*    xft_calc_string_size($, $xftFont, $label, w, h ); */
}
#line 275 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 275 "Wedit.widget"
static void copy_str(Widget self,char * s)
#else
#line 275 "Wedit.widget"
static void copy_str(self,s)Widget self;char * s;
#endif
#line 276 "Wedit.widget"
{
        m_clear( ((WeditWidget)self)->wedit.str_m );
        m_write( ((WeditWidget)self)->wedit.str_m, 0, s, strlen(s) );
        m_putc( ((WeditWidget)self)->wedit.str_m, '.' );
        str_to_glyphlist(self);
        ((WeditWidget)self)->wedit.dirty = 1;
}
#line 285 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 285 "Wedit.widget"
static void reinit(Widget self)
#else
#line 285 "Wedit.widget"
static void reinit(self)Widget self;
#endif
#line 286 "Wedit.widget"
{
        free_colors(self);
        alloc_colors(self);

        int w,h;
        calculate_prefered_size(self,&w,&h);
        make_resize_request(self,w,h);
}
#line 295 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 295 "Wedit.widget"
static void make_resize_request(Widget self,int  w,int  h)
#else
#line 295 "Wedit.widget"
static void make_resize_request(self,w,h)Widget self;int  w;int  h;
#endif
#line 296 "Wedit.widget"
{
        Dimension w_out, h_out;
        if( ((WeditWidget)self)->core.width == w && ((WeditWidget)self)->core.height == h ) return;
        if( XtMakeResizeRequest(self,w,h, &w_out, &h_out ) ==
            XtGeometryAlmost ) XtMakeResizeRequest(self,w_out,h_out,NULL,NULL );
}
#line 303 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 303 "Wedit.widget"
static void alloc_colors(Widget self)
#else
#line 303 "Wedit.widget"
static void alloc_colors(self)Widget self;
#endif
#line 304 "Wedit.widget"
{

  XGCValues     values = {
  		foreground: ((WeditWidget)self)->core.background_pixel,
  		graphics_exposures: False,
                line_width: ((WeditWidget)self)->wedit.lineWidth };
  uint          mask = GCForeground | GCGraphicsExposures |  GCLineWidth;
  ((WeditWidget)self)->wedit.gc[BG] = XtGetGC(self, mask, &values);
  values.foreground = ((WeditWidget)self)->wedit.foreground;
  ((WeditWidget)self)->wedit.gc[FG] = XtGetGC(self,mask,&values);

  mask = GCForeground | GCBackground | GCFunction;
  values.foreground = ((WeditWidget)self)->wedit.cursorColor ^ ((WeditWidget)self)->core.background_pixel;
  values.background = ((WeditWidget)self)->core.background_pixel;
  values.function = GXxor;
  ((WeditWidget)self)->wedit.gc[CRSR] = XtGetGC(self, mask, &values);

  xft_color_alloc( self, ((WeditWidget)self)->core.background_pixel, ((WeditWidget)self)->wedit.xcol+BG );
  xft_color_alloc( self, ((WeditWidget)self)->wedit.foreground,       ((WeditWidget)self)->wedit.xcol+FG );
  xft_color_alloc( self, ((WeditWidget)self)->wedit.cursorColor,      ((WeditWidget)self)->wedit.xcol+CRSR );
}
#line 326 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 326 "Wedit.widget"
static void free_colors(Widget self)
#else
#line 326 "Wedit.widget"
static void free_colors(self)Widget self;
#endif
#line 327 "Wedit.widget"
{
        int i;
        Display *dpy = XtDisplay(self);
        for(i=0;i<2;i++) {
                XtReleaseGC(self,((WeditWidget)self)->wedit.gc[i]);
                XftColorFree(dpy, DefaultVisual(dpy, DefaultScreen(dpy)),
		 None, ((WeditWidget)self)->wedit.xcol+i);
        }
}
#line 339 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 339 "Wedit.widget"
static void draw_glyphs_spec(Widget self,int  start,int  stop)
#else
#line 339 "Wedit.widget"
static void draw_glyphs_spec(self,start,stop)Widget self;int  start;int  stop;
#endif
#line 340 "Wedit.widget"
{
    int i, xa = 0;
    if( start < 0 ) start = 0;
    if( stop > m_len(((WeditWidget)self)->wedit.glyph_m) ) stop = m_len(((WeditWidget)self)->wedit.glyph_m)-1;
    if( stop < start ) return;

    for( i=start; i <= stop; i++ ) {
        get_glyph_spec(self,i)->x = xa;
        xa += INT(((WeditWidget)self)->wedit.glyph_xoff_m,i);
    }

    XftDrawGlyphFontSpec( ((WeditWidget)self)->wedit.draw, ((WeditWidget)self)->wedit.xcol + FG,
                          mls(((WeditWidget)self)->wedit.glyph_m, start), stop-start +1 );
}
#line 356 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 356 "Wedit.widget"
static void draw_glyphs(Widget self)
#else
#line 356 "Wedit.widget"
static void draw_glyphs(self)Widget self;
#endif
#line 357 "Wedit.widget"
{
    if( ((WeditWidget)self)->wedit.dirty_str ) str_to_glyphlist(self);

    int nglyphs = m_len(((WeditWidget)self)->wedit.glyph_m) -1;

    int width = ((WeditWidget)self)->wedit.pix.r.width;
    int p = ((WeditWidget)self)->wedit.left_char_offset;
    while( p < nglyphs ) {
        width -= INT(((WeditWidget)self)->wedit.glyph_xoff_m,p);
        if( width < 0 ) break;
        p++;
    }

    draw_glyphs_spec(self, ((WeditWidget)self)->wedit.left_char_offset, p-1 );
}
#line 375 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 375 "Wedit.widget"
static void unicode_to_glyphspec(Widget self,uint  unicode,XftGlyphFontSpec * specs,int * xp,int * yp,int * xOff)
#else
#line 375 "Wedit.widget"
static void unicode_to_glyphspec(self,unicode,specs,xp,yp,xOff)Widget self;uint  unicode;XftGlyphFontSpec * specs;int * xp;int * yp;int * xOff;
#endif
#line 376 "Wedit.widget"
{
    Display *dpy = XtDisplay(self);
    static FT_UInt glyph_fallback = 0;
    FT_UInt glyphindex;
    XGlyphInfo extents;
    XftFont *fnt = ((WeditWidget)self)->wedit.xftFont;

    if( !glyph_fallback )
        glyph_fallback = XftCharIndex(dpy,fnt, '#' );

    fnt = font_unicode_find(((WeditWidget)self)->wedit.fontName, unicode,(int*) &glyphindex );
    if(!glyphindex) {
             fnt=((WeditWidget)self)->wedit.xftFont;
             glyphindex = glyph_fallback;
    }
    XftGlyphExtents( dpy, fnt, &glyphindex, 1, &extents );
    specs->font = fnt;
    specs->glyph = glyphindex;
    specs->x = *xp;
    specs->y = *yp;
    *xp += extents.xOff;
    *yp += extents.yOff;
    *xOff = extents.xOff;
}
#line 405 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 405 "Wedit.widget"
static void str_to_glyphlist(Widget self)
#else
#line 405 "Wedit.widget"
static void str_to_glyphlist(self)Widget self;
#endif
#line 406 "Wedit.widget"
{
    int unicode;
    int p;
    int xp,yp;
    yp = ((WeditWidget)self)->wedit.xftFont->ascent;
    xp = 0;

    m_clear( ((WeditWidget)self)->wedit.glyph_m );
    m_clear( ((WeditWidget)self)->wedit.glyph_xoff_m );
    p=0;
    while( (unicode = m_utf8char(((WeditWidget)self)->wedit.str_m, &p)) != -1 )
        {
            unicode_to_glyphspec( self, unicode, m_add(((WeditWidget)self)->wedit.glyph_m), &xp, &yp,
                                  m_add(((WeditWidget)self)->wedit.glyph_xoff_m) );
        }

    ((WeditWidget)self)->wedit.txt.x = 0;
    ((WeditWidget)self)->wedit.txt.y = 0;
    ((WeditWidget)self)->wedit.txt.width  = xp;
    ((WeditWidget)self)->wedit.txt.height = ((WeditWidget)self)->wedit.xftFont->ascent + ((WeditWidget)self)->wedit.xftFont->descent+2;

    ((WeditWidget)self)->wedit.dirty = 1;         /* ggf. update der bildschirmausgabe */
    ((WeditWidget)self)->wedit.dirty_str = 0;     /* glyphlist ist aktualisiert */
}
#line 431 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 431 "Wedit.widget"
static int  char_offset(Widget self,int  index)
#else
#line 431 "Wedit.widget"
static int  char_offset(self,index)Widget self;int  index;
#endif
#line 432 "Wedit.widget"
{
    int i,p1=0;
    for(i=0;i<index;i++)
        m_utf8char( ((WeditWidget)self)->wedit.str_m, &p1 );
    return p1;
}
#line 442 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 442 "Wedit.widget"
static void insert_char_at_cursor(Widget self,char * buf,int  len)
#else
#line 442 "Wedit.widget"
static void insert_char_at_cursor(self,buf,len)Widget self;char * buf;int  len;
#endif
#line 443 "Wedit.widget"
{
    int p = char_offset(self,((WeditWidget)self)->wedit.crsr_pos);
    m_ins( ((WeditWidget)self)->wedit.str_m, p, len );
    m_write( ((WeditWidget)self)->wedit.str_m, p, buf, len );
    str_to_glyphlist(self);
    ((WeditWidget)self)->wedit.dirty = 1;
}
#line 451 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 451 "Wedit.widget"
static void remove_char_at_cursor(Widget self)
#else
#line 451 "Wedit.widget"
static void remove_char_at_cursor(self)Widget self;
#endif
#line 452 "Wedit.widget"
{
    int p1=0, p2=0;
    if( ((WeditWidget)self)->wedit.crsr_pos >= m_len(((WeditWidget)self)->wedit.glyph_m)-1 ) return;
    m_del( ((WeditWidget)self)->wedit.glyph_m, ((WeditWidget)self)->wedit.crsr_pos );
    m_del( ((WeditWidget)self)->wedit.glyph_xoff_m, ((WeditWidget)self)->wedit.crsr_pos );
    p1 = char_offset(self,((WeditWidget)self)->wedit.crsr_pos);
    p2=p1; m_utf8char( ((WeditWidget)self)->wedit.str_m, &p2 );
    m_remove( ((WeditWidget)self)->wedit.str_m, p1, p2-p1 );
    ((WeditWidget)self)->wedit.dirty     = 1;
}
#line 463 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 463 "Wedit.widget"
static char  scroll_left(Widget self)
#else
#line 463 "Wedit.widget"
static char  scroll_left(self)Widget self;
#endif
#line 464 "Wedit.widget"
{
    if( ((WeditWidget)self)->wedit.left_char_offset < m_len(((WeditWidget)self)->wedit.glyph_m)-1 ) {
        ((WeditWidget)self)->wedit.left_char_offset++;
        ((WeditWidget)self)->wedit.dirty = 1;
        return 0;
    }
    return -1;
}
#line 473 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 473 "Wedit.widget"
static char  scroll_right(Widget self)
#else
#line 473 "Wedit.widget"
static char  scroll_right(self)Widget self;
#endif
#line 474 "Wedit.widget"
{
    if( ((WeditWidget)self)->wedit.left_char_offset <= 0 ) return -1;
    ((WeditWidget)self)->wedit.left_char_offset--;
    ((WeditWidget)self)->wedit.dirty = 1;
    return 0;
}
#line 488 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 488 "Wedit.widget"
static int  px_left_offset(Widget self)
#else
#line 488 "Wedit.widget"
static int  px_left_offset(self)Widget self;
#endif
#line 489 "Wedit.widget"
{
    return px_char(self,((WeditWidget)self)->wedit.left_char_offset);
}
#line 496 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 496 "Wedit.widget"
static int  px_char(Widget self,int  index)
#else
#line 496 "Wedit.widget"
static int  px_char(self,index)Widget self;int  index;
#endif
#line 497 "Wedit.widget"
{
    int x=0,i;
    for(i=0;i<index;i++)
        x+= INT(((WeditWidget)self)->wedit.glyph_xoff_m, i);
    return x;
}
#line 506 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 506 "Wedit.widget"
static int  screen_px(Widget self,int  index)
#else
#line 506 "Wedit.widget"
static int  screen_px(self,index)Widget self;int  index;
#endif
#line 507 "Wedit.widget"
{
    return px_char(self,index) - px_left_offset(self);
}
#line 518 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 518 "Wedit.widget"
static void cursor_right(Widget self)
#else
#line 518 "Wedit.widget"
static void cursor_right(self)Widget self;
#endif
#line 519 "Wedit.widget"
{
    int xa = 0;
    if( ((WeditWidget)self)->wedit.crsr_pos >= m_len( ((WeditWidget)self)->wedit.glyph_m ) -1 ) return;

    ((WeditWidget)self)->wedit.crsr_pos++;
    /* das zeichen unter dem cursor sollte komplett sichtbar sein */
    while(1) {
        xa = screen_px(self, ((WeditWidget)self)->wedit.crsr_pos );
        xa += INT(((WeditWidget)self)->wedit.glyph_xoff_m,((WeditWidget)self)->wedit.crsr_pos);
        if( xa <= ((WeditWidget)self)->wedit.pix.r.width ) break;
        if( scroll_left(self) ) break;
    }
}
#line 536 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 536 "Wedit.widget"
static void cursor_left(Widget self)
#else
#line 536 "Wedit.widget"
static void cursor_left(self)Widget self;
#endif
#line 537 "Wedit.widget"
{
    int xa;
    if( ((WeditWidget)self)->wedit.crsr_pos <= 0 ) return;

    ((WeditWidget)self)->wedit.crsr_pos--;
    while(1) {
      xa = screen_px(self, ((WeditWidget)self)->wedit.crsr_pos );
      if( xa >= 0 ) break;
      if( scroll_right(self) ) break;
    }
}
#line 551 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 551 "Wedit.widget"
static void RequestSelection(Widget self,XtPointer  client,Atom * selection,Atom * type,XtPointer  value,unsigned  long * length,int * format)
#else
#line 551 "Wedit.widget"
static void RequestSelection(self,client,selection,type,value,length,format)Widget self;XtPointer  client;Atom * selection;Atom * type;XtPointer  value;unsigned  long * length;int * format;
#endif
#line 552 "Wedit.widget"
{
    char *s = value;
    int len = *length;
    if( is_empty(s) || len <= 0 ) return;
    insert_char_at_cursor(self,s,len);
    while( utf8char(&s) != -1 ) cursor_right(self);
    paint(self);
}

static XtResource resources[] = {
#line 24 "Wedit.widget"
{XtNfontName,XtCFontName,XtRString,sizeof(((WeditRec*)NULL)->wedit.fontName),XtOffsetOf(WeditRec,wedit.fontName),XtRString,(XtPointer)"Source Code Pro-22"},
#line 25 "Wedit.widget"
{XtNforeground,XtCForeground,XtRPixel,sizeof(((WeditRec*)NULL)->wedit.foreground),XtOffsetOf(WeditRec,wedit.foreground),XtRImmediate,(XtPointer)XtDefaultForeground },
#line 26 "Wedit.widget"
{XtNcursorColor,XtCCursorColor,XtRPixel,sizeof(((WeditRec*)NULL)->wedit.cursorColor),XtOffsetOf(WeditRec,wedit.cursorColor),XtRImmediate,(XtPointer)XtDefaultForeground },
#line 27 "Wedit.widget"
{XtNlineWidth,XtCLineWidth,XtRInt,sizeof(((WeditRec*)NULL)->wedit.lineWidth),XtOffsetOf(WeditRec,wedit.lineWidth),XtRImmediate,(XtPointer)1 },
#line 28 "Wedit.widget"
{XtNcornerRoundPercent,XtCCornerRoundPercent,XtRInt,sizeof(((WeditRec*)NULL)->wedit.cornerRoundPercent),XtOffsetOf(WeditRec,wedit.cornerRoundPercent),XtRImmediate,(XtPointer)20 },
#line 29 "Wedit.widget"
{XtNcallback,XtCCallback,XtRCallback,sizeof(((WeditRec*)NULL)->wedit.callback),XtOffsetOf(WeditRec,wedit.callback),XtRImmediate,(XtPointer)NULL },
#line 30 "Wedit.widget"
{XtNlabel,XtCLabel,XtRString,sizeof(((WeditRec*)NULL)->wedit.label),XtOffsetOf(WeditRec,wedit.label),XtRImmediate,(XtPointer)NULL },
};

WeditClassRec weditClassRec = {
{ /* core_class part */
/* superclass   	*/  (WidgetClass) &coreClassRec,
/* class_name   	*/  "Wedit",
/* widget_size  	*/  sizeof(WeditRec),
/* class_initialize 	*/  NULL,
/* class_part_initialize*/  _resolve_inheritance,
/* class_inited 	*/  FALSE,
/* initialize   	*/  initialize,
/* initialize_hook 	*/  NULL,
/* realize      	*/  realize,
/* actions      	*/  actionsList,
/* num_actions  	*/  8,
/* resources    	*/  resources,
/* num_resources 	*/  7,
/* xrm_class    	*/  NULLQUARK,
/* compres_motion 	*/  False ,
/* compress_exposure 	*/  FALSE ,
/* compress_enterleave 	*/  False ,
/* visible_interest 	*/  False ,
/* destroy      	*/  destroy,
/* resize       	*/  resize,
/* expose       	*/  expose,
/* set_values   	*/  set_values,
/* set_values_hook 	*/  NULL,
/* set_values_almost 	*/  XtInheritSetValuesAlmost,
/* get_values+hook 	*/  get_values_hook,
/* accept_focus 	*/  XtInheritAcceptFocus,
/* version      	*/  XtVersion,
/* callback_private 	*/  NULL,
/* tm_table      	*/  defaultTranslations,
/* query_geometry 	*/  XtInheritQueryGeometry,
/* display_acceleator 	*/  XtInheritDisplayAccelerator,
/* extension    	*/  NULL 
},
{ /* Wedit_class part */
/* XA_UTF8_STRING */  0 ,
},
};
WidgetClass weditWidgetClass = (WidgetClass) &weditClassRec;
/*ARGSUSED*/
#line 564 "Wedit.widget"
static void info(self,event,params,num_params)Widget self;XEvent*event;String*params;Cardinal*num_params;
{
    dump(self);
}

/*ARGSUSED*/
#line 569 "Wedit.widget"
static void backward_char(self,event,params,num_params)Widget self;XEvent*event;String*params;Cardinal*num_params;
{
    cursor_left(self);
    if( ((WeditWidget)self)->wedit.dirty ) paint(self); else draw_cursor(self);
}

/*ARGSUSED*/
#line 575 "Wedit.widget"
static void forward_char(self,event,params,num_params)Widget self;XEvent*event;String*params;Cardinal*num_params;
{
    cursor_right(self);
    if( ((WeditWidget)self)->wedit.dirty ) paint(self); else draw_cursor(self);
}

/*ARGSUSED*/
#line 581 "Wedit.widget"
static void insert_char(self,event,params,num_params)Widget self;XEvent*event;String*params;Cardinal*num_params;
{
    int len;
    unsigned char buf[32];
    KeySym key_sim;

    len = _XawLookupString(self,(XKeyEvent *) event, (char*)buf,sizeof buf, &key_sim );
    if (len <= 0) return;

    insert_char_at_cursor(self, (char*)buf, len );
    cursor_right(self);
    paint(self);
}

/*ARGSUSED*/
#line 595 "Wedit.widget"
static void remove_char(self,event,params,num_params)Widget self;XEvent*event;String*params;Cardinal*num_params;
{
    remove_char_at_cursor(self);
    paint(self);
}

/*ARGSUSED*/
#line 601 "Wedit.widget"
static void set_cursor(self,event,params,num_params)Widget self;XEvent*event;String*params;Cardinal*num_params;
{
    int x = event->xbutton.x;
    int y = event->xbutton.y;
    x -= ((WeditWidget)self)->wedit.pix.r.x;
    y -= ((WeditWidget)self)->wedit.pix.r.y;
    int p = ((WeditWidget)self)->wedit.left_char_offset;
    int pix = 0;
    do {
        pix += INT(((WeditWidget)self)->wedit.glyph_xoff_m, p);
        if( x < pix ) break;
        p++;
    } while( p < (m_len(((WeditWidget)self)->wedit.glyph_xoff_m)-1) );
    ((WeditWidget)self)->wedit.crsr_pos = p;
    draw_cursor(self);
}

/*ARGSUSED*/
#line 620 "Wedit.widget"
static void insert_selection(self,event,params,num_params)Widget self;XEvent*event;String*params;Cardinal*num_params;
{
    XtGetSelectionValue(self, XA_PRIMARY, ((WeditWidgetClass)self->core.widget_class)->wedit_class.XA_UTF8_STRING,
                        RequestSelection,
                        NULL, 0 );
}

/*ARGSUSED*/
#line 627 "Wedit.widget"
static void notify(self,event,params,num_params)Widget self;XEvent*event;String*params;Cardinal*num_params;
{
  XtCallCallbackList( self, ((WeditWidget)self)->wedit.callback, event );
}

static void _resolve_inheritance(class)
WidgetClass class;
{
  WeditWidgetClass c __attribute__((unused)) = (WeditWidgetClass) class;
  WeditWidgetClass super __attribute__((unused));
  if (class == weditWidgetClass) return;
  super = (WeditWidgetClass)class->core_class.superclass;
}
#line 65 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 65 "Wedit.widget"
static void initialize(Widget  request,Widget self,ArgList  args,Cardinal * num_args)
#else
#line 65 "Wedit.widget"
static void initialize(request,self,args,num_args)Widget  request;Widget self;ArgList  args;Cardinal * num_args;
#endif
#line 66 "Wedit.widget"
{
  Display *dpy = XtDisplay(self);
 /*
     $xftFont = 0;
  */
 ((WeditWidget)self)->wedit.draw = 0;
 // ((WeditWidget)self)->wedit.xftFont = XftFontOpenName( dpy, DefaultScreen(dpy), ((WeditWidget)self)->wedit.fontName );
  ((WeditWidget)self)->wedit.xftFont = font_load(dpy, DefaultScreen(dpy), ((WeditWidget)self)->wedit.fontName );
  int w,h;
  alloc_colors(self);
  if(! ((WeditWidget)self)->wedit.label ) ((WeditWidget)self)->wedit.label = ((WeditWidget)self)->core.name;
  ((WeditWidget)self)->wedit.glyph_m = m_create( 50, sizeof(XftGlyphFontSpec) );
  ((WeditWidget)self)->wedit.glyph_xoff_m = m_create( 50, sizeof(int) );
  ((WeditWidget)self)->wedit.str_m  = m_create( 50, 1 );
  ((WeditWidget)self)->wedit.label_m = m_create( 50, 1 );
  char *s = ((WeditWidget)self)->wedit.label; if( is_empty(s) ) s=((WeditWidget)self)->core.name;
  copy_str( self, s );

  calculate_prefered_size(self,&w,&h);
  if( ((WeditWidget)self)->core.width < w ) ((WeditWidget)self)->core.width = w;
  if( ((WeditWidget)self)->core.height < h) ((WeditWidget)self)->core.height = h;
  if(! ((WeditWidgetClass)self->core.widget_class)->wedit_class.XA_UTF8_STRING )
      ((WeditWidgetClass)self->core.widget_class)->wedit_class.XA_UTF8_STRING = XInternAtom(XtDisplay(self), "UTF8_STRING", True);
}
#line 91 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 91 "Wedit.widget"
static void destroy(Widget self)
#else
#line 91 "Wedit.widget"
static void destroy(self)Widget self;
#endif
#line 92 "Wedit.widget"
{
        free_colors(self);
        XftDrawDestroy( ((WeditWidget)self)->wedit.draw );
        m_free(((WeditWidget)self)->wedit.glyph_m);
        m_free(((WeditWidget)self)->wedit.str_m);
        m_free(((WeditWidget)self)->wedit.glyph_xoff_m);
        m_free(((WeditWidget)self)->wedit.label_m);
}
#line 101 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 101 "Wedit.widget"
static Boolean  set_values(Widget  old,Widget  request,Widget self,ArgList  args,Cardinal * num_args)
#else
#line 101 "Wedit.widget"
static Boolean  set_values(old,request,self,args,num_args)Widget  old;Widget  request;Widget self;ArgList  args;Cardinal * num_args;
#endif
#line 102 "Wedit.widget"
{
    int i;
    for(i=0;i<*num_args;i++) {
        if( strcmp(args[i].name, "label" ) ==0 )
            {
                copy_str(self, ((WeditWidget)self)->wedit.label );
            }
    }
    reinit(self);
    return True; /* call expose() to update widget */
}
#line 114 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 114 "Wedit.widget"
static void get_values_hook(Widget self,ArgList  args,Cardinal * num_args)
#else
#line 114 "Wedit.widget"
static void get_values_hook(self,args,num_args)Widget self;ArgList  args;Cardinal * num_args;
#endif
#line 115 "Wedit.widget"
{
    int i;
    for(i=0;i<*num_args;i++) {
        if( strcmp(args[i].name, "label" ) ==0 )
            {
                int l = m_len(((WeditWidget)self)->wedit.str_m);
                m_write(((WeditWidget)self)->wedit.label_m, 0, m_buf(((WeditWidget)self)->wedit.str_m), l );
                CHAR(((WeditWidget)self)->wedit.label_m, l-1)=0;
                *((char**)args[i].value) = m_buf(((WeditWidget)self)->wedit.label_m);
                return;
            }
    }
}
#line 130 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 130 "Wedit.widget"
static void expose(Widget self,XEvent * event,Region  region)
#else
#line 130 "Wedit.widget"
static void expose(self,event,region)Widget self;XEvent * event;Region  region;
#endif
#line 131 "Wedit.widget"
{
  Display *dpy = XtDisplay(self);
  XClearWindow( dpy, XtWindow(self) );
  ((WeditWidget)self)->wedit.crsr_on = 0; /* cursor not visible */
  paint(self);
}
#line 138 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 138 "Wedit.widget"
static void realize(Widget self,XtValueMask * mask,XSetWindowAttributes * attributes)
#else
#line 138 "Wedit.widget"
static void realize(self,mask,attributes)Widget self;XtValueMask * mask;XSetWindowAttributes * attributes;
#endif
#line 139 "Wedit.widget"
{
	XtCreateWindow(self, (unsigned int) InputOutput,
        		  (Visual *) CopyFromParent, *mask, attributes);
  	resize_widget(self);
}
#line 145 "Wedit.widget"
/*ARGSUSED*/
#if NeedFunctionPrototypes
#line 145 "Wedit.widget"
static void resize(Widget self)
#else
#line 145 "Wedit.widget"
static void resize(self)Widget self;
#endif
#line 146 "Wedit.widget"
{
    if (XtIsRealized(self)) resize_widget(self);
}
